---
title: 'Análisis Características: Patologias Sistemicas'
author: "Manuel Rocamora Valenti"
date: "`r Sys.Date()`"
output: html_document
---

# 1. Carga y Visualización de datos

En este primer punto, se cargan, se separan y visualizan brevemente la disposición de los datos.

```{r}
# Carga de datos
data = read.csv('Arreglo_datos/combianted_Total.csv')

# Me quedo con los datos de Patologias Sistemicas
datos_Patologia_Sistemica <- data[, 1:57]
head(datos_Patologia_Sistemica)
```

Como podemos observar, la mayoría de las variables son binarias, para algunas de ellas tenemos que aplicar algunas transformaciones.

Vamos a binarizar, tanto la variable de Alchol y la del Genero.

```{r}
library(caret)

columnas_a_convertir <- c("Alcohol", "Genero")

# Crear un modelo de dummy variables
modelo_dummy <- dummyVars(~ ., data = datos_Patologia_Sistemica[columnas_a_convertir], levelsOnly = TRUE)

# Aplicar el modelo para transformar las columnas
df <- predict(modelo_dummy, newdata = datos_Patologia_Sistemica[columnas_a_convertir])

# Unir las nuevas columnas al dataframe original
datos_Patologia_Sistemica <- cbind(datos_Patologia_Sistemica, df)

# Quitar las columnas originales si es necesario
datos_Patologia_Sistemica <- datos_Patologia_Sistemica[, !names(datos_Patologia_Sistemica) %in% columnas_a_convertir]

# Muestra el dataframe resultante
head(datos_Patologia_Sistemica)
```

El siguiente paso, vamos a filtar la fecha de nacimiento, para quedarnos tan solo con el año en que nació el paciente, para comprobar si la edad, puede ser una variable de peso en nuestro análisis.

```{r}
# Convertir la columna de fecha de nacimiento a formato de fecha
datos_Patologia_Sistemica$Fecha_Nacimiento <- as.Date(datos_Patologia_Sistemica$Fecha_Nacimiento, format = "%d/%m/%y")

# Convertir la columna de fecha de intervención a formato de fecha
datos_Patologia_Sistemica$Fecha_intervencion <- as.Date(datos_Patologia_Sistemica$Fecha_intervencion, format = "%d/%m/%y")

# Verificar si la fecha de intervención es anterior a la fecha de nacimiento
intercambiar_fechas <- datos_Patologia_Sistemica$Fecha_intervencion < datos_Patologia_Sistemica$Fecha_Nacimiento

datos_Patologia_Sistemica <- na.omit(datos_Patologia_Sistemica)

# Calcular la edad
datos_Patologia_Sistemica$Edad <- as.numeric(format(Sys.Date(), "%Y")) - as.numeric(format(datos_Patologia_Sistemica$Fecha_Nacimiento, "%Y"))

# Eliminar filas con edades igual a 0 años o negativas
datos_Patologia_Sistemica <- datos_Patologia_Sistemica[datos_Patologia_Sistemica$Edad > 0, ]

# Definir los rangos de edad
rangos_edad <- c(0, 18, 65, Inf) # Jóvenes (0-18), Adultos (19-65), Ancianos (66 o más)

# Etiquetas para los rangos de edad
etiquetas_edad <- c("Jovenes", "Adultos", "Ancianos")

# Crear la variable categórica de edad
datos_Patologia_Sistemica$Grupo_Edad <- cut(datos_Patologia_Sistemica$Edad, breaks = rangos_edad, labels = etiquetas_edad, right = FALSE)

# ______________Binarizamos los datos
library(caret)

columnas_a_convertir <- c('Grupo_Edad')

# Crear un modelo de dummy variables
modelo_dummy <- dummyVars(~ ., data = datos_Patologia_Sistemica[columnas_a_convertir], levelsOnly = TRUE)

# Aplicar el modelo para transformar las columnas
df <- predict(modelo_dummy, newdata = datos_Patologia_Sistemica[columnas_a_convertir])

# Unir las nuevas columnas al dataframe original
datos_Patologia_Sistemica <- cbind(datos_Patologia_Sistemica, df)

# Quitar las columnas originales si es necesario
datos_Patologia_Sistemica <- datos_Patologia_Sistemica[, !names(datos_Patologia_Sistemica) %in% columnas_a_convertir]

# Muestra el dataframe resultante
head(datos_Patologia_Sistemica)
```

Por último, eliminamos las variables que no vamos a introducir en nuestro análisis, estas son:

-   Date_Create

-   Fecha_intervencion

-   Fecha_Nacimiento

-   Edad

```{r}
# Por ultimo, eliminamos las columnas que no vayamos a meter en el cluster
library(dplyr)

# Eliminar las columnas
datos_Patologia_Sistemica <- select(datos_Patologia_Sistemica, -Date_Create, -Fecha_intervencion, -Fecha_Nacimiento, -Edad)
datos_Patologia_Sistemica
```

Una vez tenemos los datos preparados, vamos a por siguiente punto.

# 2. Análisis PCA y Clustering

## PCA

Comenzamos con el PCA, en este análisis vamos a comprobar el pero que tienen algunas de las variables y ver aquellas que son mas importantes para la interpretación de los datos.

```{r}
# Instala y carga los paquetes necesarios
library(factoextra)
library(cluster)

# Realiza un análisis de componentes principales (PCA)
pca_result <- prcomp(datos_Patologia_Sistemica)

# Visualiza la varianza explicada por cada componente principal
fviz_eig(pca_result)
fviz_pca_ind(pca_result,
             geom.ind = "point", 
             col.ind = "cos2", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE,
             ggtheme = theme_minimal()) +
  theme(legend.position = "right")
# Gráfico de correlaciones entre variables y ejes principales
fviz_contrib(pca_result, choice = "var", axes = 1:2, top = 10)

# Gráfico de correlaciones entre individuos y ejes principales
fviz_contrib(pca_result, choice = "ind", axes = 1:2, top = 10)

# Biplot
# Crear el biplot solo con las variables más importantes
fviz_pca_biplot(pca_result,
                col.ind = "cos2", 
                col.var = "contrib",
                repel = TRUE,
                ggtheme = theme_minimal()) +
  theme(legend.position = "right") +
  scale_color_gradient(low = "white", high = "red") +  # Cambiar la escala de colores
  scale_shape_manual(values = c(1, 16))  # Cambiar la forma de los puntos

# Control variable colors using their contributions
fviz_pca_var(pca_result, col.var="contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping
             )


# Use habillage to specify groups for coloring
#fviz_pca_ind(pca_result,
 #            label = "none", # hide individual labels
  #           habillage = datos_Patologia_Sistemica$operaciones, # color by groups
   #          palette = c("#00AFBB", "#E7B800", "#FC4E07"),
   #addEllipses = TRUE # Concentration ellipses)



```
